<!-- Student Management Card -->
<mat-card class="student-management-card">

  <!-- Card Header with Actions -->
  <mat-card-header class="card-header">
    <div class="header-content">
      <div class="title-section">
        <mat-card-title class="main-title">
          <mat-icon class="title-icon">school</mat-icon>
          Student Management System
        </mat-card-title>
        <mat-card-subtitle>Manage your student records efficiently</mat-card-subtitle>
      </div>

      <div class="action-section">
        <button
          mat-raised-button
          color="primary"
          (click)="onAddStudent()"
          class="add-student-btn">
          <mat-icon>person_add</mat-icon>
          Add Student
        </button>
      </div>
    </div>
  </mat-card-header>

  <mat-card-content class="card-content">

    <!-- Student Form -->
    <app-student-form
      [isVisible]="isFormVisible"
      [student]="selectedStudent"
      (formSubmit)="onFormSubmit($event)"
      (formCancel)="onFormCancel()">
    </app-student-form>

    <!-- Filter Controls -->
    <mat-toolbar class="filter-toolbar" color="accent">
      <span class="toolbar-title">
        <mat-icon>filter_list</mat-icon>
        Search Filters
      </span>
      <span class="spacer"></span>
      <mat-chip-set *ngIf="getActiveFilterCount() > 0" class="filter-chips">
        <mat-chip class="filter-count-chip">
          {{ getActiveFilterCount() }} Active Filter{{ getActiveFilterCount() !== 1 ? 's' : '' }}
        </mat-chip>
      </mat-chip-set>
      <button 
        mat-icon-button 
        (click)="clearAllFilters()"
        [disabled]="getActiveFilterCount() === 0"
        matTooltip="Clear all filters">
        <mat-icon>clear_all</mat-icon>
      </button>
    </mat-toolbar>

    <!-- Material Data Table -->
    <div class="table-container" *ngIf="students.length > 0; else noDataTemplate">
      
      <!-- Results Summary -->
      <div class="results-summary">
        <span class="results-text">
          Showing {{ dataSource.data.length }} of {{ students.length }} students
        </span>
      </div>

      <!-- Material Table -->
      <div class="table-scroll-container">
        <table mat-table [dataSource]="dataSource" class="student-table mat-elevation-2">
        
          <!-- First Name Column -->
        <ng-container matColumnDef="firstName">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">person</mat-icon>
              <span>First Name</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <span class="cell-content" [title]="student.firstName">{{ student.firstName }}</span>
          </td>
        </ng-container>

        <!-- First Name Filter Row -->
        <ng-container matColumnDef="firstName-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.firstName"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Middle Name Column -->
        <ng-container matColumnDef="middleName">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">person_outline</mat-icon>
              <span>Middle Name</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <span class="cell-content" [title]="student.middleName">{{ student.middleName }}</span>
          </td>
        </ng-container>

        <!-- Middle Name Filter Row -->
        <ng-container matColumnDef="middleName-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.middleName"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Last Name Column -->
        <ng-container matColumnDef="lastName">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">badge</mat-icon>
              <span>Last Name</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <span class="cell-content" [title]="student.lastName">{{ student.lastName }}</span>
          </td>
        </ng-container>

        <!-- Last Name Filter Row -->
        <ng-container matColumnDef="lastName-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.lastName"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Age Column -->
        <ng-container matColumnDef="age">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">cake</mat-icon>
              <span>Age</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <mat-chip class="age-chip">{{ student.age }}</mat-chip>
          </td>
        </ng-container>

        <!-- Age Filter Row -->
        <ng-container matColumnDef="age-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.age"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Class Column -->
        <ng-container matColumnDef="class">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">class</mat-icon>
              <span>Class</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <mat-chip class="class-chip" color="primary">{{ student.class }}</mat-chip>
          </td>
        </ng-container>

        <!-- Class Filter Row -->
        <ng-container matColumnDef="class-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.class"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Division Column -->
        <ng-container matColumnDef="division">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">group</mat-icon>
              <span>Division</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <mat-chip class="division-chip" color="accent">{{ student.division }}</mat-chip>
          </td>
        </ng-container>

        <!-- Division Filter Row -->
        <ng-container matColumnDef="division-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.division"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Date of Birth Column -->
        <ng-container matColumnDef="dateOfBirth">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">event</mat-icon>
              <span>Date of Birth</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <div class="date-content">
              <mat-icon class="date-icon">calendar_today</mat-icon>
              <span>{{ formatDate(student.dateOfBirth) }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Date of Birth Filter Row -->
        <ng-container matColumnDef="dateOfBirth-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.dateOfBirth"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef class="header-cell">
            <div class="header-content">
              <mat-icon class="column-icon">email</mat-icon>
              <span>Email</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell">
            <div class="email-content" [title]="student.email">
              <mat-icon class="email-icon">alternate_email</mat-icon>
              <span class="email-text">{{ student.email }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Email Filter Row -->
        <ng-container matColumnDef="email-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell">
            <mat-form-field appearance="outline" class="filter-input">
              <input 
                matInput 
                [(ngModel)]="searchFilters.email"
                (input)="onSearchChange()"
                placeholder="Search...">
            </mat-form-field>
          </th>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="header-cell actions-header">
            <div class="header-content">
              <mat-icon class="column-icon">settings</mat-icon>
              <span>Actions</span>
            </div>
          </th>
          <td mat-cell *matCellDef="let student" class="data-cell actions-cell">
            <div class="action-buttons">
              <button 
                mat-mini-fab 
                color="primary"
                (click)="onEditStudent(student)"
                matTooltip="Edit Student"
                class="action-btn edit-btn">
                <mat-icon>edit</mat-icon>
              </button>
              <button 
                mat-mini-fab 
                color="warn"
                (click)="onDeleteStudent(student)"
                matTooltip="Delete Student"
                class="action-btn delete-btn">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <!-- Actions Filter Row (Empty) -->
        <ng-container matColumnDef="actions-filter">
          <th mat-header-cell *matHeaderCellDef class="filter-cell actions-filter">
            <!-- Empty cell for actions column -->
          </th>
        </ng-container>

          <!-- Table Rows -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></tr>
          <tr mat-header-row *matHeaderRowDef="filterColumns" class="filter-row"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row"></tr>
        </table>
      </div>

      <!-- No Results Message -->
      <div class="no-results-container" *ngIf="dataSource.data.length === 0 && students.length > 0">
        <mat-card class="no-results-card">
          <mat-card-content class="no-results-content">
            <mat-icon class="no-results-icon">search_off</mat-icon>
            <h3 class="no-results-title">No Results Found</h3>
            <p class="no-results-text">
              No students match your current search criteria. Try adjusting your filters or clear all filters to see all students.
            </p>
            <button 
              mat-raised-button 
              color="accent" 
              (click)="clearAllFilters()"
              class="clear-filters-btn">
              <mat-icon>clear_all</mat-icon>
              Clear All Filters
            </button>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- No Data Template -->
    <ng-template #noDataTemplate>
      <div class="no-data-container">
        <mat-card class="no-data-card">
          <mat-card-content class="no-data-content">
            <mat-icon class="no-data-icon">school</mat-icon>
            <h3 class="no-data-title">No Students Found</h3>
            <p class="no-data-text">
              Get started by adding your first student to the system.
            </p>
            <button 
              mat-raised-button 
              color="primary" 
              (click)="onAddStudent()"
              class="add-first-student-btn">
              <mat-icon>person_add</mat-icon>
              Add Your First Student
            </button>
          </mat-card-content>
        </mat-card>
      </div>
    </ng-template>

  </mat-card-content>
</mat-card>

<rforex-loader [isLoading]="isLoading"></rforex-loader>

<form
  class="mat-elevation-z4 mat-form"
  [formGroup]="transactionForm"
  autocomplete="off"
  (ngSubmit)="addTransaction()"
>
  <h2 class="mat-headline-5 mat-primary mb-4 text-uppercase">
    Transaction Form
  </h2>

  <div class="mat-form-row">
    <mat-form-field appearance="outline" class="mat-flex">
      <mat-label>Buy Amount</mat-label>
      <input
        matInput
        type="text"
        maxlength="18"
        formControlName="buyAmount"
        id="buy-amount-field"
        placeholder="Amount"
        appAmountConverter
      />
      <mat-hint align="end" class="text-info fst-italic">{{
        buyAmountControl.value | NumberToWords
      }}</mat-hint>
      <div class="input-suffix-icons">
        <img matSuffix src="united-states-flag-icon-1.png" />
        <!-- <mat-icon matSuffix color="primary">arrow_upward</mat-icon> -->
      </div>
      @if(buyAmountControl?.hasError('required') ||
      buyAmountControl?.hasError('nonZeroValue')){
      <mat-error>Buy Amount is required.</mat-error>
      }
      <!-- @if(buyAmountControl?.hasError('nonZeroValue')){
      <mat-error>Amount should be greater than zero</mat-error>
      }  -->
      @if(buyAmountControl?.hasError('invalidDecimal')){
      <mat-error
        >If there is a decimal, it must be followed by at least one
        digit.</mat-error
      >
      } @if( buyAmountControl?.hasError('mustStartWithNumber')) {<mat-error>
        Input must start with a number. </mat-error
      >} @if(buyAmountControl?.hasError('noSpacesAllowed')) {<mat-error>
        No spaces are allowed. </mat-error
      >} @if(buyAmountControl?.hasError('mustStartWithNumber')) {<mat-error>
        Input must start with a number. </mat-error
      >} @if(buyAmountControl?.hasError('invalidNumber')) {
      <mat-error> Decimal Values not allowed. </mat-error>
      } @if(buyAmountControl?.hasError('multipleDecimal')) {<mat-error>
        Multiple Decimals not allowed. </mat-error
      >}
    </mat-form-field>

    <mat-form-field appearance="outline" class="mat-flex">
      <mat-label>Sell Amount</mat-label>
      <input
        matInput
        maxlength="18"
        type="text"
        formControlName="sellAmount"
        id="sell-amount-field"
        placeholder="Amount"
        appAmountConverter
      />
      <mat-hint align="end" class="text-info fst-italic">{{
        sellAmountControl.value | NumberToWords
      }}</mat-hint>
      <div class="input-suffix-icons">
        <img class="input-icon" matSuffix src="united-states-flag-icon-1.png" />
        <!-- <mat-icon matSuffix color="warn">arrow_downward</mat-icon> -->
      </div>
      @if(sellAmountControl?.hasError('required') ||
      sellAmountControl?.hasError('nonZeroValue')){
      <mat-error>Sell Amount is required.</mat-error>
      }
      <!-- @if(sellAmountControl?.hasError('nonZeroValue')){
      <mat-error>Amount should be greater than zero</mat-error>
      } -->
      @if(sellAmountControl?.hasError('invalidDecimal')){
      <mat-error
        >If there is a decimal, it must be followed by at least one
        digit.</mat-error
      >
      } @if( sellAmountControl?.hasError('mustStartWithNumber')) {<mat-error>
        Input must start with a number. </mat-error
      >} @if(sellAmountControl?.hasError('noSpacesAllowed')) {<mat-error>
        No spaces are allowed. </mat-error
      >} @if(sellAmountControl?.hasError('mustStartWithNumber')) {<mat-error>
        Input must start with a number. </mat-error
      >} @if(sellAmountControl?.hasError('invalidNumber')) {
      <mat-error> Decimal Values not allowed. </mat-error>
      } @if(sellAmountControl?.hasError('multipleDecimal')) {<mat-error>
        Multiple Decimals not allowed. </mat-error
      >}
    </mat-form-field>
  </div>

  <div class="mat-form-row">
    <mat-form-field appearance="outline" class="mat-flex">
      <mat-label>Big Figure</mat-label>
      <input
        matInput
        type="text"
        formControlName="bigFigure"
        id="big-figure"
        autocomplete="off"
        (wheel)="$event.preventDefault()"
        FourDigitsOnly
        (keydown)="onlyNumberKey($event)"
      />
      @if(bigFigureControl?.hasError('required')){
      <mat-error>Big Figure is required</mat-error>
      } @if(bigFigureControl?.hasError('outOfRange')){
      <mat-error>
        Big Figure must be between
        {{ bigFigureControl?.getError("outOfRange").min }} and
        {{ bigFigureControl?.getError("outOfRange").max }}
      </mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="mat-flex">
      <mat-label>Small Figure</mat-label>
      <input
        matInput
        type="text"
        formControlName="smallFigure"
        id="small-figure"
        autocomplete="off"
        (keydown)="onlyNumberKey($event)"
        [maxLength]="Small_Figure_Decimal"
      />
      @if(smallFigureControl?.hasError('required')){
      <mat-error>Small Figure is required</mat-error>
      } @if(smallFigureControl?.hasError('outOfRange')) {<mat-error>
        Small Figure must be between
        {{ smallFigureControl?.getError("outOfRange").min }} and
        {{ smallFigureControl?.getError("outOfRange").max }} </mat-error
      >}
    </mat-form-field>
  </div>

  <div class="mat-form-row">
    <mat-form-field appearance="outline" class="mat-flex">
      <mat-label>CounterParty</mat-label>
      <input
        matInput
        type="text"
        formControlName="counterParty"
        id="counter-party"
        [matAutocomplete]="autoCounterParty"
      />
      <mat-autocomplete #autoCounterParty="matAutocomplete">
        <mat-option
          *ngFor="let counterParty of filteredParties"
          [value]="counterParty"
        >
          {{ counterParty }}
        </mat-option>
      </mat-autocomplete>
      <mat-icon matSuffix>person_outline</mat-icon>
      @if(counterPartyControl?.hasError('required')){
      <mat-error>Counter Party is required</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="mat-flex">
      <mat-label>Dealer</mat-label>
      <input
        matInput
        type="text"
        formControlName="dealer"
        id="dealer"
        autocomplete="off"
      />
      @if (!dealerControl?.hasError('required')) {
      <mat-icon matSuffix>badge</mat-icon>
      } @if (dealerControl?.hasError('required')) {
      <mat-error>Dealer ID is required</mat-error>
      }
    </mat-form-field>
  </div>

  <div class="mt-4 d-flex justify-content-end">
    <button
      mat-raised-button
      color="primary"
      type="button"
      [disabled]="transactionForm.invalid || disableSubmit"
    >
      <mat-icon>add_circle</mat-icon>
      ADD TRANSACTION
    </button>
  </div>
</form>
